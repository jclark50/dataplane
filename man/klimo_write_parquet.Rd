% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/klimo_write_parquet.R
\name{klimo_write_parquet}
\alias{klimo_write_parquet}
\title{Write a Parquet file with Klimo spec metadata (units + scaling + audit)}
\usage{
klimo_write_parquet(
  x,
  path,
  field_spec = NULL,
  declared_system = c("metric", "imperial"),
  unit_mode = c("validate", "none", "convert"),
  unit_strict = FALSE,
  src_units = NULL,
  scaled = FALSE,
  scaled_suffix = "_i",
  drop_original = TRUE,
  compression = "zstd",
  tag_missing_units = FALSE,
  tag_missing_units_warn = TRUE,
  tag_missing_units_max_show = 12L,
  ...
)
}
\arguments{
\item{x}{A data.frame/data.table. Will be converted to data.table internally.}

\item{path}{Output parquet path.}

\item{field_spec}{NULL, `"metric"`, `"imperial"`, a `klimo_spec`, or a spec `data.table`.
If NULL: writes without a spec and emits a message showing how to attach defaults.}

\item{unit_mode}{`"validate"` (default), `"none"`, or `"convert"`.}

\item{unit_strict}{If TRUE, validation errors stop instead of warning. For convert mode,
this also controls whether missing sources stop.}

\item{src_units}{Named character vector of source units for untagged columns (convert mode only),
e.g., `c(ta="degF", td="degF")`.}

\item{scaled}{Logical. If TRUE, apply scaling as described above.}

\item{scaled_suffix}{Suffix for scaled columns, default `"_i"`.}

\item{drop_original}{If TRUE, drop original numeric columns that were scaled.}

\item{compression}{Parquet compression codec; passed to `arrow::write_parquet`.}

\item{...}{Additional arguments passed to `arrow::write_parquet`.}

\item{system}{If `field_spec` is custom, which units column to treat as declared units
(`"metric"` or `"imperial"`). Ignored if `field_spec` is `"metric"`/`"imperial"` or a
`klimo_spec` with `system` already set.}
}
\value{
Invisibly returns a list with:
  - `path`
  - `spec` (klimo_spec or NULL)
  - `preview` (data.table)
  - `audit` (data.table)
}
\description{
`klimo_write_parquet()` writes a dataset to a Parquet file (via `arrow`) and
stores a robust specification + audit trail in Parquet key_value_metadata.
}
\details{
It implements a hybrid unit strategy:

**Unit modes**
- `unit_mode = "none"`: write without validating or converting; metadata still includes
  declared units (if spec present) and observed units (if attributes exist).
- `unit_mode = "validate"` (recommended default): does not convert values; it checks
  `attr(x[[col]], "unit")` against declared units and warns (or errors if strict).
- `unit_mode = "convert"`: converts numeric columns to declared units using `unit<-`
  (from this package) and then writes. If the column has no `attr(unit)`, you must
  provide `src_units` (named vector), otherwise conversion is refused.

**Scaling**
- If `scaled = TRUE` and a column has `suggested_scale`, the writer will create a scaled
  integer column named `paste0(column, scaled_suffix)` (default: `"_i"`). Optionally
  drops the original.

**Metadata keys written**
- `klimo:spec_version`, `klimo:spec_system`
- `klimo:field_spec_json` (JSON; spec table)
- `klimo:audit_json` (JSON; declared vs observed units + status + scaling status)

#' Key simplification:
- There is no separate `system` argument anymore.
- The declared system comes from the spec (klimo_spec) or from `declared_system`
  when `field_spec` is provided as a plain data.table/data.frame.
}
\examples{
# Minimal example (document-only, no conversion, no scaling):
library(data.table)
dat <- data.table(ta = c(20, 21), rh = c(50, 55), lat = c(35.9, 36.0), lon = c(-78.9, -78.8))
klimo_write_parquet(dat, tempfile(fileext = ".parquet"), field_spec = "metric", unit_mode = "none", scaled = FALSE)

# Convert-on-write (requires unit() tagging or src_units):
# unit(dat$ta) <- "degF"  # if already known
}
